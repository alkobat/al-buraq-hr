# مخطط تدفق: النظام القديم vs النظام الجديد

## 📊 الوضع الحالي (Current State)

```
┌─────────────────────────────────────────────────────────┐
│          قاعدة البيانات system_settings                 │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  🔵 auto_send_user = '' (معطل)                         │
│     └─→ ✅ مستخدم في admin/users.php                   │
│     └─→ ✅ مستخدم في evaluator/users.php               │
│     └─→ يرسل كلمة المرور للمستخدم الجديد               │
│                                                         │
│  🔴 auto_send_eval = '' (معطل)                         │
│     └─→ ❌ غير مستخدم في أي ملف!                      │
│     └─→ ⚠️ يظهر في الواجهة لكن لا يفعل شيء            │
│                                                         │
│  🟢 evaluation_email_manager_only_enabled = '0'        │
│  🟢 evaluation_email_available_score_mode = 'any'      │
│  🟢 evaluation_email_average_complete_mode = '...'     │
│     └─→ ✅ مستخدمة في app/core/EmailService.php       │
│     └─→ تحكم متقدم في إرسال التقييمات                  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 🔄 تدفق إرسال البريد للمستخدمين الجدد (يعمل حالياً)

```
                    إضافة مستخدم جديد
                            │
                            ├─→ admin/users.php (line 332)
                            └─→ evaluator/users.php (line 273)
                            │
                            ▼
               ┌────────────────────────────┐
               │  فحص auto_send_user        │
               │  (من system_settings)     │
               └────────────┬───────────────┘
                            │
               ┌────────────┴────────────┐
               │                         │
        ✅ القيمة = '1'           ❌ فارغ أو '0'
               │                         │
               ▼                         ▼
    ┌──────────────────┐         ┌──────────────┐
    │ استدعاء Mailer   │         │ لا شيء        │
    │ إرسال البريد     │         │              │
    └──────────────────┘         └──────────────┘
```

---

## ❗ تدفق إرسال البريد للتقييمات (النظام القديم - معطل)

```
                  إرسال تقييم من مدير/مشرف
                            │
                            ▼
               ┌────────────────────────────┐
               │  هل يوجد فحص؟              │
               │  auto_send_eval            │
               └────────────┬───────────────┘
                            │
                            ▼
                    ❌ لا يوجد فحص!
                            │
                            ▼
                  (الإعداد موجود لكن مهمل)
```

---

## ✅ تدفق إرسال البريد للتقييمات (النظام الجديد - يعمل حالياً)

```
                  إرسال تقييم (Submit)
                            │
               ┌────────────┴────────────┐
               │                         │
     manager/evaluate.php        supervisor/evaluate.php
         (line 378)                  (line 236)
               │                         │
               └────────────┬────────────┘
                            ▼
               ┌────────────────────────────┐
               │ EmailService               │
               │ handleEvaluationSubmitted()│
               └────────────┬───────────────┘
                            │
                            ▼
               ┌────────────────────────────┐
               │ ما هي طريقة الحساب؟       │
               │ (evaluation_method)        │
               └────────┬───────────────────┘
                        │
        ┌───────────────┼───────────────┐
        │               │               │
        ▼               ▼               ▼
   manager_only   available_score  average_complete
        │               │               │
        ▼               ▼               ▼
   ┌─────────┐    ┌─────────┐    ┌─────────┐
   │ فحص     │    │ فحص     │    │ فحص     │
   │ SETTING │    │ SETTING │    │ SETTING │
   │ 1       │    │ 2       │    │ 3       │
   └────┬────┘    └────┬────┘    └────┬────┘
        │              │              │
        │              │              │
   ┌────┴──────────────┴──────────────┴────┐
   │                                        │
   │  منطق متقدم:                          │
   │  - هل الموظف له رئيس مباشر؟           │
   │  - من قيّم؟ (مدير/مشرف/كلاهما)        │
   │  - هل اكتمل التقييم؟                  │
   │  - أي وضع إرسال مختار؟                │
   │                                        │
   └────────────────┬───────────────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
        ▼                       ▼
   إرسال بريد              لا شيء
   للموظف                 (حسب الشروط)
```

---

## 🎯 الحل المقترح: إضافة Master Toggle

```
                  إرسال تقييم (Submit)
                            │
               ┌────────────┴────────────┐
               │                         │
     manager/evaluate.php        supervisor/evaluate.php
               │                         │
               └────────────┬────────────┘
                            ▼
               ┌────────────────────────────────┐
               │ EmailService                   │
               │ handleEvaluationSubmitted()    │
               └────────────┬───────────────────┘
                            │
                            ▼
               ┌────────────────────────────────┐
               │  🆕 فحص Master Toggle          │
               │  auto_send_eval == '1' ?       │
               └────────┬───────────────────────┘
                        │
           ┌────────────┴────────────┐
           │                         │
    ✅ نعم ('1')              ❌ لا (فارغ)
           │                         │
           ▼                         ▼
    استمر بالمنطق          ┌──────────────┐
    المتقدم الحالي          │  STOP        │
           │               │  لا ترسل شيء │
           ▼               └──────────────┘
   [المخطط السابق]
   (فحص الطريقة
   ثم الإعدادات
   ثم الشروط...)
```

---

## 📱 تجربة المستخدم: قبل وبعد

### ❌ الوضع الحالي (مربك)

```
المسؤول يريد إيقاف جميع رسائل التقييمات

1. يذهب إلى email_settings.php
2. يرى "إرسال تلقائي عند اكتمال التقييم"
3. يعطّل الخيار ✓
4. ينتظر...
5. ❗ الرسائل ما زالت ترسل!
6. حيرة وإرباك

لماذا؟
└─→ لأن الإعداد غير مستخدم في الكود!
```

### ✅ بعد الإصلاح (واضح)

```
المسؤول يريد إيقاف جميع رسائل التقييمات

السيناريو 1: إيقاف كامل (سريع)
┌─────────────────────────────────┐
│ email_settings.php              │
│                                 │
│ [  ] إرسال رسائل التقييمات     │
│      (المفتاح الرئيسي)          │
│                                 │
│ 💡 للتحكم في التفاصيل، اذهب    │
│    إلى إعدادات النظام           │
└─────────────────────────────────┘
    تعطيل هنا = إيقاف فوري ✓

السيناريو 2: تحكم تفصيلي (متقدم)
┌─────────────────────────────────┐
│ settings.php                    │
│                                 │
│ ✓ الطريقة: average_complete    │
│                                 │
│ [ ] إرسال عند المدير فقط        │
│ [✓] إرسال تنبيه بانتظار المشرف │
│ [✓] إرسال رسالة نهائية          │
└─────────────────────────────────┘
    تحكم دقيق في كل حالة

⚠️ ملاحظة: Master Toggle OFF = تعطيل الكل
```

---

## 🔍 جدول القرار: متى يتم الإرسال؟

| Master Toggle | الطريقة | الإعداد الفرعي | النتيجة |
|--------------|---------|----------------|---------|
| ❌ OFF | أي | أي | ❌ لا يرسل |
| ✅ ON | manager_only | ❌ معطل | ❌ لا يرسل |
| ✅ ON | manager_only | ✅ مفعّل | ✅ يرسل عند المدير |
| ✅ ON | available_score | any | ✅ يرسل عند أي تقييم |
| ✅ ON | available_score | both | ✅ يرسل عند اكتمال الاثنين |
| ✅ ON | average_complete | waiting_supervisor... | ✅ يرسل حسب الحالة |

---

## 🏗️ بنية الإعدادات المقترحة

```
system_settings
│
├─ SMTP Configuration (خادم البريد)
│  ├─ smtp_host
│  ├─ smtp_port
│  ├─ smtp_user
│  ├─ smtp_pass
│  ├─ smtp_secure
│  ├─ smtp_from_email
│  └─ smtp_from_name
│
├─ 🔵 Global Toggles (المفاتيح الرئيسية)
│  ├─ auto_send_user [المستخدمين الجدد]
│  └─ auto_send_eval [التقييمات] ← 🆕 سيُستخدم كـ Master
│
└─ 🟢 Evaluation Email Details (تفاصيل التقييمات)
   │
   ├─ evaluation_method (طريقة الحساب)
   │
   └─ Conditional Settings (حسب الطريقة)
      ├─ evaluation_email_manager_only_enabled
      ├─ evaluation_email_available_score_mode
      └─ evaluation_email_average_complete_mode
```

---

## 🎬 سيناريوهات الاختبار

### سيناريو 1: إيقاف طارئ
```
الموقف: خطأ في القوالب - يجب إيقاف الإرسال فوراً

✅ الحل:
1. المسؤول → email_settings.php
2. تعطيل auto_send_eval
3. حفظ
4. ✓ جميع الرسائل توقفت فوراً

⏱️ الوقت: 10 ثواني
```

### سيناريو 2: تفعيل انتقائي
```
الموقف: نريد إرسال رسائل فقط عند اكتمال التقييم

✅ الخطوات:
1. email_settings.php: auto_send_eval = ON
2. settings.php: evaluation_method = average_complete
3. settings.php: mode = both_only
4. حفظ
5. ✓ يرسل فقط عند اكتمال المدير + المشرف

🎯 دقة: كاملة
```

### سيناريو 3: اختبار ما قبل الإطلاق
```
الموقف: نريد اختبار النظام بدون إرسال حقيقي

✅ الطريقة السهلة:
1. email_settings.php: auto_send_eval = OFF
2. اختبر جميع السيناريوهات
3. (لا ترسل رسائل فعلاً)
4. عند الجاهزية: auto_send_eval = ON

🔒 أمان: كامل
```

---

## 📈 مقارنة التعقيد

```
┌─────────────────────┬─────────┬─────────┐
│                     │ القديم  │ المقترح │
├─────────────────────┼─────────┼─────────┤
│ عدد ملفات الإعدادات │    2    │    2    │
│ عدد الإعدادات الكلية│    1    │  1+3    │
│ مستوى التحكم        │  بسيط   │  متقدم  │
│ مفتاح طوارئ         │   ❌    │   ✅    │
│ سهولة للمبتدئ       │   ✅    │   ✅    │
│ قوة للمتقدم         │   ❌    │   ✅    │
│ عدد النقرات (إيقاف)│    2    │    2    │
│ الوضوح              │   ❌    │   ✅    │
└─────────────────────┴─────────┴─────────┘
```

---

## ⚡ خلاصة التطبيق

### الكود المطلوب إضافته (سطر واحد فعلياً!)

```php
// app/core/EmailService.php - في بداية handleEvaluationSubmitted()

public function handleEvaluationSubmitted($employeeId, $cycleId, $evaluatorRole, $evaluatorId)
{
    // 🆕 فحص Master Toggle
    if ($this->getSetting('auto_send_eval', '0') !== '1') {
        return; // إيقاف فوري
    }
    
    // ... باقي الكود الحالي بدون تغيير
    try {
        $method = $this->calculator->getEvaluationMethod();
        ...
```

### التحديث في الواجهة (اختياري لكن موصى به)

```php
// public/admin/email_settings.php - تحديث النص فقط

<div class="form-check form-switch mb-3">
    <input ... name="auto_send_eval" ...>
    <label class="form-check-label">
        <strong>المفتاح الرئيسي:</strong> تفعيل رسائل التقييمات
        <br><small class="text-muted">
            (يتم التحكم في تفاصيل الإرسال من 
            <a href="settings.php">إعدادات النظام</a>)
        </small>
    </label>
</div>
```

---

**نهاية المخطط** ✅
