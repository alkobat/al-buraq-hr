# ุชูุฑูุฑ ุชุญููู ุงูุชุถุงุฑุจ ุจูู ุฅุนุฏุงุฏุงุช ุงูุจุฑูุฏ ุงููุฏููุฉ ูุงูุฌุฏูุฏุฉ

## ๐ ููุฎุต ุชูููุฐู

ุชู ุงูุชุดุงู **ุชุถุงุฑุจ ูุธููู** ุจูู ุงููุธุงู ุงููุฏูู ูุงูุฌุฏูุฏ ูุฅุนุฏุงุฏุงุช ุฅุฑุณุงู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููุชููููุงุช. ุงูุฅุนุฏุงุฏ ุงููุฏูู `auto_send_eval` ููุฌูุฏ ูู ุงููุงุฌูุฉ ูููู **ุบูุฑ ูุณุชุฎุฏู ูุนููุงู** ูู ุงูููุฏุ ููุง ูุณุจุจ ุงุฑุจุงูุงู ูููุณุชุฎุฏููู.

---

## 1๏ธโฃ ูุญุต ุงูุฅุนุฏุงุฏุงุช ุงููุฏููุฉ

### โ ุฅุนุฏุงุฏ "ุฅุฑุณุงู ุชููุงุฆู ููููุธู ุนูุฏ ุงูุชูุงู ุงูุชูููู ูู ุงููุฏูุฑ"

#### ๐ ุงููููุน:
- **ุงูููู:** `/public/admin/email_settings.php`
- **ุงูุณุทุฑ:** 76-78

```php
<div class="form-check form-switch mb-3">
    <input class="form-check-input" type="checkbox" name="auto_send_eval" value="1" <?= $settings['auto_send_eval']=='1'?'checked':''?>>
    <label class="form-check-label">ุฅุฑุณุงู ุชููุงุฆู ููููุธู ุนูุฏ ุงูุชูุงู ุงูุชูููู ูู ุงููุฏูุฑ</label>
</div>
```

#### ๐๏ธ ูุงุนุฏุฉ ุงูุจูุงูุงุช:
- **ุงูุฌุฏูู:** `system_settings`
- **ุงุณู ุงูุนููุฏ:** `key` (ูุญุชูู ุนูู "auto_send_eval")
- **ููุน ุงูุจูุงูุงุช:** VARCHAR - ูููุฉ ูุตูุฉ
- **ุงููููุฉ ุงูุญุงููุฉ:** `''` (ูุงุฑุบุฉ - ุบูุฑ ููุนูู)

```sql
+-----------------+-------+
| key             | value |
+-----------------+-------+
| auto_send_eval  |       |
+-----------------+-------+
```

#### ๐พ ููุทู ุงูุญูุธ:
- **ุงูุณุทุฑ 17 ูู email_settings.php:**
```php
$keys = ['smtp_host', 'smtp_port', 'smtp_user', 'smtp_pass', 'smtp_secure', 'smtp_from_email', 'smtp_from_name', 'auto_send_user', 'auto_send_eval'];
foreach ($keys as $key) {
    $val = $_POST[$key] ?? '';
    $pdo->prepare("UPDATE system_settings SET `value` = ? WHERE `key` = ?")->execute([$val, $key]);
}
```

---

## 2๏ธโฃ ูุญุต ุฅุนุฏุงุฏุงุช SMTP

### ๐ก ุฅุนุฏุงุฏุงุช ุงูุฎุงุฏู SMTP

#### ๐ ุงููููุน:
- **ุงูุฌุฏูู:** `system_settings`
- **ุงููููุงุช ุงููุณุชุฎุฏูุฉ:** `app/core/Mailer.php`, `public/admin/email_settings.php`

#### โ๏ธ ุงูุฅุนุฏุงุฏุงุช ุงููุชููุฑุฉ:

| ุงูููุชุงุญ | ุงููููุฉ ุงูุญุงููุฉ | ุงููุตู |
|---------|-----------------|-------|
| `smtp_host` | mail.buraq.aero | ุนููุงู ุฎุงุฏู ุงูุจุฑูุฏ |
| `smtp_port` | 465 | ูููุฐ ุงูุฎุงุฏู |
| `smtp_user` | hr@buraq.aero | ุงุณู ุงููุณุชุฎุฏู |
| `smtp_pass` | buraq@1234 | ูููุฉ ุงููุฑูุฑ |
| `smtp_secure` | ssl | ููุน ุงูุชุดููุฑ (TLS/SSL) |
| `smtp_from_email` | hr@buraq.aero | ุงูุจุฑูุฏ ุงููุฑุณู |
| `smtp_from_name` | ูุธุงู ุชูููู ุงูุฃุฏุงุก | ุงุณู ุงููุฑุณู |

#### ๐ง ููููุฉ ุงูุงุณุชุฎุฏุงู:
ูู `app/core/Mailer.php` (ุงูุณุทุฑ 9-28):
```php
public function __construct($pdo) {
    $this->pdo = $pdo;
    $stmt = $this->pdo->query("SELECT `key`, `value` FROM system_settings");
    $this->settings = $stmt->fetchAll(PDO::FETCH_KEY_PAIR);
}

private function getMailer() {
    $mail = new PHPMailer(true);
    $mail->isSMTP();
    $mail->Host       = $this->settings['smtp_host'];
    $mail->SMTPAuth   = true;
    $mail->Username   = $this->settings['smtp_user'];
    $mail->Password   = $this->settings['smtp_pass'];
    $mail->SMTPSecure = $this->settings['smtp_secure'];
    $mail->Port       = $this->settings['smtp_port'];
    // ...
}
```

โ **ุงููุชูุฌุฉ:** ุฅุนุฏุงุฏุงุช SMTP ุชุนูู ุจุดูู ุตุญูุญ ููุชูุงูู.

---

## 3๏ธโฃ ุงูุจุญุซ ุนู ุงูููุทู ุงููุฏูู

### ๐ ุงุณุชุฎุฏุงู `auto_send_eval` ูู ุงูููุฏ:

#### ูุชูุฌุฉ ุงูุจุญุซ:
```bash
grep -r "auto_send_eval" --include="*.php"
```

**ุงููุชูุฌุฉ:** ุชู ุงูุนุซูุฑ ุนูู `auto_send_eval` ูู ููู ูุงุญุฏ ููุท:
- โ `/public/admin/email_settings.php` - ุงููุงุฌูุฉ ููุท (ุนุฑุถ ูุญูุธ)
- โ **ูุง ููุฌุฏ ุฃู ุงุณุชุฎุฏุงู ูุนูู** ูู ููุทู ุงูุฅุฑุณุงู!

### ๐ ุงุณุชุฎุฏุงู `auto_send_user` (ููููุงุฑูุฉ):

#### ูุชูุฌุฉ ุงูุจุญุซ:
โ ุชู ุงูุนุซูุฑ ุนูู ุงุณุชุฎุฏุงู ูุนูู ูู 3 ูููุงุช:
1. `/public/admin/email_settings.php` - ุงููุงุฌูุฉ
2. **`/public/admin/users.php` - ุงูุงุณุชุฎุฏุงู ุงููุนูู:**

```php
// ุงูุณุทุฑ 332-342
$settings = $pdo->query("SELECT value FROM system_settings WHERE `key`='auto_send_user'")->fetchColumn();
if ($settings == '1') {
    $mailer = new Mailer($pdo);
    $plain_password = !empty($_POST['password']) ? $_POST['password'] : $password; 
    $mailer->sendEmail($email, $name, 'new_user', [
        'name' => $name,
        'email' => $email,
        'password' => $plain_password
    ]);
}
```

โ **ุงููุชูุฌุฉ:** `auto_send_user` ูุนูู ุจุดูู ุตุญูุญ.

---

## 4๏ธโฃ ุงููุธุงู ุงูุฌุฏูุฏ (EmailService)

### ๐ ุงูุจููุฉ ุงูุฌุฏูุฏุฉ:

#### ๐ ุงูููู ุงูุฑุฆูุณู: `app/core/EmailService.php`

#### โ๏ธ ุงูุฅุนุฏุงุฏุงุช ุงูุฌุฏูุฏุฉ:

| ุงูููุชุงุญ | ุงููุตู | ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ |
|---------|-------|-------------------|
| `evaluation_email_manager_only_enabled` | ุชูุนูู ุงูุฅุฑุณุงู ููุทุฑููุฉ ุงูุฃููู (manager_only) | '0' |
| `evaluation_email_available_score_mode` | ูุถุน ุงูุฅุฑุณุงู ููุทุฑููุฉ ุงูุซุงููุฉ | 'any' |
| `evaluation_email_average_complete_mode` | ูุถุน ุงูุฅุฑุณุงู ููุทุฑููุฉ ุงูุซุงูุซุฉ | 'waiting_supervisor_plus_final' |

#### ๐ ููุทู ุงูุฅุฑุณุงู:

ูู `manager/evaluate.php` (ุงูุณุทุฑ 377-384):
```php
try {
    require_once '../../app/core/EmailService.php';
    $emailService = new EmailService($pdo);
    $emailService->handleEvaluationSubmitted($employee_id, $active_cycle['id'], 'manager', $manager_id);
} catch (Exception $mailEx) {
    error_log('Conditional evaluation email failed (manager): ' . $mailEx->getMessage());
}
```

ูู `supervisor/evaluate.php` (ุงูุณุทุฑ 236-242):
```php
try {
   require_once '../../app/core/EmailService.php';
   $emailService = new EmailService($pdo);
   $emailService->handleEvaluationSubmitted($employee_id, $active_cycle['id'], 'supervisor', $supervisor_id);
} catch (Exception $mailEx) {
   error_log('Conditional evaluation email failed (supervisor): ' . $mailEx->getMessage());
}
```

#### ๐ฏ ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ: `handleEvaluationSubmitted()`

```php
public function handleEvaluationSubmitted($employeeId, $cycleId, $evaluatorRole, $evaluatorId)
{
    try {
        $method = $this->calculator->getEvaluationMethod();
        
        // ุชุฃูุฏ ูู ูุฌูุฏ ุฑุงุจุท ุตุงูุญ ุฏุงุฆูุงู
        $this->getOrCreateEmployeeEvaluationToken($employeeId, $cycleId);
        
        if ($method === EvaluationCalculator::METHOD_MANAGER_ONLY) {
            if ($evaluatorRole === 'manager' && $this->getSetting(self::SETTING_MANAGER_ONLY_ENABLED, '0') === '1') {
                $this->sendEvaluationNotification($employeeId, $cycleId, $method, $evaluatorRole, $evaluatorId);
            }
            return;
        }
        
        // ... ููุทู ุงูุทุฑู ุงูุฃุฎุฑู
    }
}
```

โ **ุงููุชูุฌุฉ:** ุงููุธุงู ุงูุฌุฏูุฏ ูุชุทูุฑ ููุง ููุญุต `auto_send_eval` ุนูู ุงูุฅุทูุงู!

---

## 5๏ธโฃ ุงูุชุญููู - ุงูุชุถุงุฑุจ ูุงููุดุงูู

### โ ุงููุดููุฉ ุงูุฑุฆูุณูุฉ:

#### 1. **ุฅุนุฏุงุฏ "ุดุจุญ" ุบูุฑ ูุนูุงู:**
- `auto_send_eval` ููุฌูุฏ ูู ุงููุงุฌูุฉ (`email_settings.php`)
- ุงููุณุชุฎุฏู ูุนุชูุฏ ุฃูู ูุชุญูู ูู ุงูุฅุฑุณุงู
- **ูููู ูุง ููุนู ุดูุฆุงู ุนูู ุงูุฅุทูุงู!**

#### 2. **ุงุฒุฏูุงุฌูุฉ ูุธูููุฉ:**
- ุงููุธุงู ุงูุฌุฏูุฏ ูููุฑ ููุณ ุงููุธููุฉ ุจุดูู ุฃูุซุฑ ุชุทูุฑุงู
- ุงูุฅุนุฏุงุฏุงุช ุงูุฌุฏูุฏุฉ ููุฌูุฏุฉ ูู `settings.php`
- ุตูุญุชุงู ูุฅุฏุงุฑุฉ ููุณ ุงูุดูุก!

#### 3. **ุฅุฑุจุงู ุงููุณุชุฎุฏู:**
- ุงููุณุชุฎุฏู ูุฏ ููุนูู `auto_send_eval` ูู `email_settings.php`
- ุซู ูุชูุงุฌุฃ ุจุฃู ุงูุจุฑูุฏ ูุง ููุฑุณูู
- ุฃู ูุฏ ูุฑุณู ูู ุฎูุงู ุงููุธุงู ุงูุฌุฏูุฏ ุฑุบู ุชุนุทููู ูู ุงููุฏูู!

### โ ูุง ูุง ููุฌุฏ ุชุถุงุฑุจ ููู:

1. **ุฅุนุฏุงุฏุงุช SMTP:** ูุดุชุฑูุฉ ููุณุชุฎุฏูุฉ ูู ูุจู ููุง ุงููุธุงููู - ูุง ูุดููุฉ
2. **`auto_send_user`:** ูุนูู ุจุดูู ูุณุชูู ูุตุญูุญ - ูุง ูุดููุฉ

---

## 6๏ธโฃ ุงูุชูุตูุงุช

### ๐ฏ ุงูุญู ุงูููุตู ุจู: **ุฅุฒุงูุฉ ุงูุฅุนุฏุงุฏ ุงููุฏูู**

#### โ ุงููุจุฑุฑุงุช:
1. โ ุงูุฅุนุฏุงุฏ ุงููุฏูู ุบูุฑ ูุณุชุฎุฏู ูุนููุงู
2. โ ุงููุธุงู ุงูุฌุฏูุฏ ุฃูุซุฑ ุชุทูุฑุงู ูุดููููุฉ
3. โ ูููู ุงูุฅุฑุจุงู ูููุณุชุฎุฏู ุงูููุงุฆู
4. โ ูุณูู ุงูุตูุงูุฉ ุงููุณุชูุจููุฉ

### ๐ ุงูุฎุทูุงุช ุงููุทููุจุฉ:

#### 1๏ธโฃ **ุฅุฒุงูุฉ ูู ุงููุงุฌูุฉ** (`email_settings.php`)
ุญุฐู ุงูููุฏ ุงูุชุงูู (ุงูุณุทุฑ 76-78):
```php
<div class="form-check form-switch mb-3">
    <input class="form-check-input" type="checkbox" name="auto_send_eval" value="1" <?= $settings['auto_send_eval']=='1'?'checked':''?>>
    <label class="form-check-label">ุฅุฑุณุงู ุชููุงุฆู ููููุธู ุนูุฏ ุงูุชูุงู ุงูุชูููู ูู ุงููุฏูุฑ</label>
</div>
```

#### 2๏ธโฃ **ุฅุฒุงูุฉ ูู ููุทู ุงูุญูุธ** (ุงูุณุทุฑ 17)
ุชุนุฏูู ุงูุณุทุฑ:
```php
// ูู:
$keys = ['smtp_host', 'smtp_port', 'smtp_user', 'smtp_pass', 'smtp_secure', 'smtp_from_email', 'smtp_from_name', 'auto_send_user', 'auto_send_eval'];

// ุฅูู:
$keys = ['smtp_host', 'smtp_port', 'smtp_user', 'smtp_pass', 'smtp_secure', 'smtp_from_email', 'smtp_from_name', 'auto_send_user'];
```

#### 3๏ธโฃ **ุชุญุฏูุซ ุงูุนููุงู ูุงููุตู**
ุฅุถุงูุฉ ููุงุญุธุฉ ุชูุถูุญูุฉ:
```html
<div class="alert alert-info mb-3">
    <i class="fas fa-info-circle"></i>
    <strong>ููุงุญุธุฉ:</strong> 
    ูุชุฎุตูุต ุฅุนุฏุงุฏุงุช ุฅุฑุณุงู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููุชููููุงุชุ ูุฑุฌู ุงูุฐูุงุจ ุฅูู:
    <a href="settings.php" class="alert-link">ุงูุฅุนุฏุงุฏุงุช โ ุฅุนุฏุงุฏุงุช ุฅุฑุณุงู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููุชููููุงุช</a>
</div>
```

#### 4๏ธโฃ **ุชูุธูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุงุฎุชูุงุฑู)**
```sql
-- ุญุฐู ุงูุฅุนุฏุงุฏ ุงููุฏูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
DELETE FROM system_settings WHERE `key` = 'auto_send_eval';
```

### ๐ ุงูุจุฏุงุฆู (ุบูุฑ ููุตู ุจูุง):

#### โ ุงูุจุฏูู 1: ุงุณุชุฎุฏุงู `auto_send_eval` ูู Master Switch
- ุณูุชุทูุจ ุชุนุฏููุงุช ูุงุณุนุฉ ูู `EmailService`
- ุฅุถุงูุฉ ูุญุต ูู ูู ุฏุงูุฉ ุฅุฑุณุงู
- **ุชุนููุฏ ุบูุฑ ุถุฑูุฑู**

```php
// ูุซุงู (ุบูุฑ ููุตู ุจู):
public function handleEvaluationSubmitted(...) {
    $master_switch = $this->getSetting('auto_send_eval', '0');
    if ($master_switch !== '1') {
        return; // ูุง ุชุฑุณู ุฃู ุดูุก
    }
    // ... ุจุงูู ุงูููุทู
}
```

#### โ ุงูุจุฏูู 2: ุฏูุฌ ุงูุตูุญุชูู
- ููู ุฅุนุฏุงุฏุงุช SMTP ุฅูู `settings.php`
- ุญุฐู `email_settings.php` ุจุงููุงูู
- **ูุฏ ูููู ูุฑุจูุงู ูุฃู settings.php ูุฒุฏุญูุฉ**

---

## 7๏ธโฃ ุฎุทุฉ ุงูุฏูุฌ ุงูููุตู ุจูุง

### โ ุงูุฎุทุฉ ุงูููุงุฆูุฉ:

1. **ุงูุขู (ููุฑู):**
   - โ ุฅุฒุงูุฉ `auto_send_eval` ูู ูุงุฌูุฉ `email_settings.php`
   - โ ุฅุถุงูุฉ ุฑุงุจุท ุชูุถูุญู ููุฅุนุฏุงุฏุงุช ุงูุฌุฏูุฏุฉ

2. **ุงููุฑุญูุฉ ุงูุซุงููุฉ (ุงุฎุชูุงุฑู):**
   - ๐ ููู ุฅุนุฏุงุฏุงุช SMTP ุฅูู `settings.php`
   - ๐ ุชุญููู `email_settings.php` ุฅูู ุตูุญุฉ ููุงูุจ ุงูุจุฑูุฏ ููุท
   - ๐ ุฅุนุงุฏุฉ ููููุฉ ุงูููุงุฆู

3. **ุงูุชูุซูู:**
   - ๐ ุชุญุฏูุซ ุฏููู ุงููุณุชุฎุฏู
   - ๐ ุดุฑุญ ุงููุฑู ุจูู ุงูุฅุนุฏุงุฏุงุช
   - ๐ ุฃูุซูุฉ ููุญุงูุงุช ุงูุดุงุฆุนุฉ

---

## 8๏ธโฃ ุชุฃุซูุฑ ุงูุชุบููุฑุงุช

### โ ุงูุฅูุฌุงุจูุงุช:
1. โ ูุงุฌูุฉ ุฃูุซุฑ ูุถูุญุงู
2. โ ุนุฏู ูุฌูุฏ ุฅุนุฏุงุฏุงุช ูุถููุฉ
3. โ ุตูุงูุฉ ุฃุณูู
4. โ ุชูููู ุงุญุชูุงููุฉ ุงูุฃุฎุทุงุก

### โ๏ธ ุงูุงุญุชูุงุทุงุช:
1. โ๏ธ ุฅุฐุง ูุงู ููุงู ูุณุชุฎุฏู ูุนูู `auto_send_eval` ุณุงุจูุงู:
   - ุณูููุฏ ูุฐุง ุงูุฅุนุฏุงุฏ (ูููู ูุงู ุบูุฑ ูุนูุงู ุฃุตูุงู)
   - ูุฌุจ ุฅุนูุงู ุงููุณุชุฎุฏููู ุจุงูุงูุชูุงู ููุฅุนุฏุงุฏุงุช ุงูุฌุฏูุฏุฉ

2. โ๏ธ ุงูุชูุงูููุฉ:
   - ุฌููุน ุงูุชุบููุฑุงุช ูุชูุงููุฉ ูุน ุงููุธุงู ุงูุญุงูู
   - ูุง ุญุงุฌุฉ ูุชุบููุฑ ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุนุฏุง ุงูุญุฐู ุงูุงุฎุชูุงุฑู)

---

## 9๏ธโฃ ุงูุฎูุงุตุฉ

### ๐ ุงููุถุน ุงูุญุงูู:

| ุงููููู | ุงูุญุงูุฉ | ุงูุฅุฌุฑุงุก |
|--------|---------|---------|
| **SMTP Settings** | โ ูุนูู ุจุดูู ุตุญูุญ | ูุง ุชุบููุฑ |
| **auto_send_user** | โ ูุนูู ุจุดูู ุตุญูุญ | ูุง ุชุบููุฑ |
| **auto_send_eval** | โ ุบูุฑ ูุณุชุฎุฏู ูุนููุงู | โ๏ธ ูุฌุจ ุงูุฅุฒุงูุฉ |
| **EmailService (ุฌุฏูุฏ)** | โ ูุนูู ุจุดูู ุตุญูุญ | โ ูุธุงู ุฃุณุงุณู |
| **Email Settings Page** | โ๏ธ ุฅุนุฏุงุฏ ุดุจุญ ููุฌูุฏ | โ๏ธ ูุญุชุงุฌ ุชูุธูู |

### ๐ฏ ุงูุชูุตูุฉ ุงูููุงุฆูุฉ:

**ุฅุฒุงูุฉ `auto_send_eval` ูู `email_settings.php` ููุฑุงู** ูุชุฌูุจ ุฅุฑุจุงู ุงููุณุชุฎุฏููู ูุงูุงุนุชูุงุฏ ุงููุงูู ุนูู ุงููุธุงู ุงูุฌุฏูุฏ ุงููุชุทูุฑ ูู `EmailService`.

---

## ๐ ุชุงุฑูุฎ ุงูุชูุฑูุฑ
**ุงูุชุงุฑูุฎ:** 2024-12-14  
**ุงููุญูู:** AI Development Assistant  
**ุงููุดุฑูุน:** ูุธุงู ุชูููู ุงูุฃุฏุงุก - ุงูุฎุทูุท ุงูุฌููุฉ ุงูุนุฑุจูุฉ ุงูุจุฑุงู

---

## ๐ ุงููููุงุช ุฐุงุช ุงูุตูุฉ

1. `/public/admin/email_settings.php` - โ๏ธ ูุญุชุงุฌ ุชุนุฏูู
2. `/public/admin/settings.php` - โ ุงููุธุงู ุงูุฌุฏูุฏ ุงูุตุญูุญ
3. `/app/core/EmailService.php` - โ ููุทู ุงูุฅุฑุณุงู ุงูุฌุฏูุฏ
4. `/app/core/Mailer.php` - โ ุฅุฑุณุงู SMTP
5. `/public/manager/evaluate.php` - โ ุงุณุชุฏุนุงุก EmailService
6. `/public/supervisor/evaluate.php` - โ ุงุณุชุฏุนุงุก EmailService
