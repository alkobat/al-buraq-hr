# ุชุญููู ุดุงูู: ุงูุชุถุงุฑุจ ุจูู ุฅุนุฏุงุฏุงุช ุงูุจุฑูุฏ ุงููุฏููุฉ ูุงูุฌุฏูุฏุฉ

## ๐ ููุฎุต ุชูููุฐู

**ุงููุถุน ุงูุญุงูู:** ูุง ููุฌุฏ ุชุถุงุฑุจ ูุนูู ุญุงููุงูุ ููู ููุฌุฏ **ุนุฏู ุงุชุณุงู** ู**ุฎุทุฑ ูุญุชูู** ููุชุถุงุฑุจ ุงููุณุชูุจูู.

**ุงูุณุจุจ:** ุงูุฅุนุฏุงุฏ ุงููุฏูู `auto_send_eval` ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุงููุงุฌูุฉ ูููู **ุบูุฑ ูุณุชุฎุฏู** ูู ุงูููุฏุ ุจูููุง ุงููุธุงู ุงูุฌุฏูุฏ ูุนูู ุจุดูู ูุณุชูู ุชูุงูุงู.

---

## 1๏ธโฃ ูุญุต ุงูุฅุนุฏุงุฏุงุช ุงููุฏููุฉ

### โ ูู ููุฌุฏ ุฅุนุฏุงุฏ "ุฅุฑุณุงู ุชููุงุฆู ููููุธู ุนูุฏ ุงูุชูุงู ุงูุชูููู"ุ
**ูุนูุ ููุฌุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.**

### ๐ ุงูุฌุฏูู ูุงูุนููุฏ
- **ุงูุฌุฏูู:** `system_settings`
- **ุงูุนููุฏ:** `key` = `'auto_send_eval'`
- **ุงููููุฉ ุงูุญุงููุฉ:** `''` (ูุงุฑุบ = ูุนุทู)
- **ุงูุณุทุฑ:** 393 ูู ููู `al_b.sql`

```sql
INSERT INTO `system_settings` (`id`, `key`, `value`) VALUES
...
(13, 'auto_send_eval', ''),     -- ๐ ููุง: ูุนุทู ุญุงููุงู
(14, 'auto_send_user', '');     -- ูููุณุชุฎุฏููู ุงูุฌุฏุฏ
```

### ๐ ููุน ุงูุฅุนุฏุงุฏ
**Toggle (ููุชุงุญ ุชุดุบูู/ุฅููุงู)**
- ุงููููุฉ `'1'` = ููุนูู
- ุงููููุฉ `''` ุฃู ุบูุฑ ููุฌูุฏุฉ = ูุนุทู

### ๐ ูููุน ุงููุงุฌูุฉ
- **ุงูููู:** `public/admin/email_settings.php`
- **ุงูุฃุณุทุฑ:** 75-78

```php
<div class="form-check form-switch mb-3">
    <input class="form-check-input" type="checkbox" name="auto_send_eval" 
           value="1" <?= $settings['auto_send_eval']=='1'?'checked':''?>>
    <label class="form-check-label">
        ุฅุฑุณุงู ุชููุงุฆู ููููุธู ุนูุฏ ุงูุชูุงู ุงูุชูููู ูู ุงููุฏูุฑ
    </label>
</div>
```

---

## 2๏ธโฃ ูุญุต ุฅุนุฏุงุฏุงุช SMTP

### โ ููุงู ูุฌูุฏ ุฅุนุฏุงุฏุงุช ุงูุฎุงุฏู
**ุงูุฌุฏูู:** `system_settings`
**ุงูููู:** `public/admin/email_settings.php` (ุฃุณุทุฑ 61-67)

### ๐ ุงูุฅุนุฏุงุฏุงุช ุงูููุฌูุฏุฉ:

| ุงูููุชุงุญ (`key`) | ุงููููุฉ ุงูุญุงููุฉ | ุงููุตู |
|-----------------|----------------|-------|
| `smtp_host` | `mail.buraq.aero` | ุนููุงู ุงูุฎุงุฏู |
| `smtp_port` | `465` | ุงููููุฐ |
| `smtp_user` | `hr@buraq.aero` | ุงุณู ุงููุณุชุฎุฏู |
| `smtp_pass` | `buraq@1234` | ูููุฉ ุงููุฑูุฑ |
| `smtp_secure` | `ssl` | ููุน ุงูุชุดููุฑ (SSL/TLS) |
| `smtp_from_email` | `hr@buraq.aero` | ุงูุจุฑูุฏ ุงููุฑุณู |
| `smtp_from_name` | `ูุธุงู ุชูููู ุงูุฃุฏุงุก` | ุงุณู ุงููุฑุณู |

**ุงููุฑุฌุน:** ุฃุณุทุฑ 385-391 ูู `al_b.sql`

---

## 3๏ธโฃ ุงูุจุญุซ ุนู ุงูููุทู ุงููุฏูู

### ๐ ุงููููุงุช ุงูุชู ุชูุญุต "auto_send_eval"

#### โ ุงููุชูุฌุฉ ุงูููุงุฌุฆุฉ:
**ูุง ููุฌุฏ ุฃู ููู ููุญุต ูุฐุง ุงูุฅุนุฏุงุฏ ุญุงููุงู!**

ุชู ุงูุจุญุซ ูู ุฌููุน ูููุงุช `.php`:
```bash
Found 3 matches for pattern "auto_send_eval|auto_send_user":
1. public/admin/email_settings.php  # ูุงุฌูุฉ ููุท (ุนุฑุถ ูุญูุธ)
2. public/admin/users.php            # ูุณุชุฎุฏู auto_send_user ููุท
3. public/evaluator/users.php        # ูุณุชุฎุฏู auto_send_user ููุท
```

### โ๏ธ ุงูุฎูุงุตุฉ ุงููููุฉ:
- ุงูุฅุนุฏุงุฏ `auto_send_eval` ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ูุธูุฑ ูู ุงููุงุฌูุฉ ููููู ุชุนุฏููู
- ูููู **ุบูุฑ ูุณุชุฎุฏู ูู ุฃู ููุงู ูู ุงูููุฏ!**

---

### ๐ข ุงูุฅุนุฏุงุฏ ุงููุณุชุฎุฏู ูุนููุงู: `auto_send_user`

#### ๐ ููู: `public/admin/users.php` (ุฃุณุทุฑ 330-343)
```php
// ุฅุฑุณุงู ุจุฑูุฏ ุงูุชุฑุญูุจ
require_once '../../app/core/Mailer.php';
$settings = $pdo->query("SELECT value FROM system_settings WHERE `key`='auto_send_user'")->fetchColumn();

if ($settings == '1') {  // ๐ ูุญุต ุงูุฅุนุฏุงุฏ ุงููุฏูู
    $mailer = new Mailer($pdo);
    $plain_password = !empty($_POST['password']) ? $_POST['password'] : $password; 
    $mailer->sendEmail($email, $name, 'new_user', [
        'name' => $name,
        'email' => $email,
        'password' => $plain_password
    ]);
}
```

**ููุณ ุงูููุทู ููุฌูุฏ ูู:** `public/evaluator/users.php` (ุฃุณุทุฑ 273-282)

---

## 4๏ธโฃ ุงููุธุงู ุงูุฌุฏูุฏ (EmailService)

### ๐ ุงูุฅุนุฏุงุฏุงุช ุงูุฌุฏูุฏุฉ (3 ุฅุนุฏุงุฏุงุช ูุชูุฏูุฉ)

ูุชู ุญูุธูุง ูู `system_settings`:

| ุงูููุชุงุญ | ุงูุงูุชุฑุงุถู | ุงููุตู |
|---------|-----------|-------|
| `evaluation_email_manager_only_enabled` | `'0'` | ููุทุฑููุฉ โ: ุชูุนูู ุงูุฅุฑุณุงู ุนูุฏ ุชูููู ุงููุฏูุฑ |
| `evaluation_email_available_score_mode` | `'any'` | ููุทุฑููุฉ โก: ูุชู ูุฑุณู (manager_only/supervisor_only/any/both) |
| `evaluation_email_average_complete_mode` | `'waiting_supervisor_plus_final'` | ููุทุฑููุฉ โข: ุงุณุชุฑุงุชูุฌูุฉ ุงูุฅุฑุณุงู |

**ุงููุฑุฌุน:** 
- `app/core/EmailService.php` (ุฃุณุทุฑ 12-21)
- `public/admin/settings.php` (ุฃุณุทุฑ 130-160)

---

### ๐ง ูุชู ูุชู ุฅุฑุณุงู ุงูุจุฑูุฏ ูู ุงููุธุงู ุงูุฌุฏูุฏุ

#### ๐ ุนูุฏ ุฅุฑุณุงู ุงูุชูููู (Submit):

**1. ูุฏูุฑ ุงูุฅุฏุงุฑุฉ** (`public/manager/evaluate.php` ุฃุณุทุฑ 378-384):
```php
// ุจุนุฏ ูุฌุงุญ ุงูุฅุฑุณุงู ูุจุงุดุฑุฉ
try {
    require_once '../../app/core/EmailService.php';
    $emailService = new EmailService($pdo);
    $emailService->handleEvaluationSubmitted(
        $employee_id, 
        $active_cycle['id'], 
        'manager',      // ุฏูุฑ ุงูููููู
        $manager_id
    );
} catch (Exception $mailEx) {
    error_log('Conditional evaluation email failed (manager): ' . $mailEx->getMessage());
}
```

**2. ุงูุฑุฆูุณ ุงููุจุงุดุฑ** (`public/supervisor/evaluate.php` ุฃุณุทุฑ 236-242):
```php
try {
    require_once '../../app/core/EmailService.php';
    $emailService = new EmailService($pdo);
    $emailService->handleEvaluationSubmitted(
        $employee_id, 
        $active_cycle['id'], 
        'supervisor',   // ุฏูุฑ ุงูููููู
        $supervisor_id
    );
} catch (Exception $mailEx) {
    error_log('Conditional evaluation email failed (supervisor): ' . $mailEx->getMessage());
}
```

---

### ๐ง ููุทู ุงููุฑุงุฑ ูู EmailService

ุงูุฏุงูุฉ `handleEvaluationSubmitted()` ุชูุฑุฑ **ุชููุงุฆูุงู** ุจูุงุกู ุนูู:

1. **ุทุฑููุฉ ุงุญุชุณุงุจ ุงูุชูููู** (`evaluation_method`):
   - `manager_only`
   - `available_score`
   - `average_complete`

2. **ุฅุนุฏุงุฏุงุช ุงูุจุฑูุฏ ุงููุฎุตุตุฉ** ููู ุทุฑููุฉ (ุงูุฌุฏูู ุฃุนูุงู)

3. **ุญุงูุฉ ุงูุชูููู**:
   - ูู ุงูููุธู ูู ุฑุฆูุณ ูุจุงุดุฑุ
   - ูู ุฃุฑุณู ุงููุฏูุฑุ ูู ุฃุฑุณู ุงููุดุฑูุ
   - ูู ุงูุชูู ุงูุชููููุ

**ุงููุฑุฌุน ุงููุงูู:** `app/core/EmailService.php` (ุฃุณุทุฑ 33-108)

---

## 5๏ธโฃ ุงูุชุญููู: ูู ูุชุถุงุฑุจุงูุ

### โ ุงููุถุน ุงูุญุงูู: **ูุง ููุฌุฏ ุชุถุงุฑุจ ูุนูู**

**ุงูุณุจุจ:**
```
ุงููุธุงู ุงููุฏูู (auto_send_eval) โ ุบูุฑ ูุณุชุฎุฏู ูู ุงูููุฏ
ุงููุธุงู ุงูุฌุฏูุฏ (EmailService) โ ูุนูู ูุจุงุดุฑุฉ ุจุฏูู ูุญุต ุฃู ุฅุนุฏุงุฏ master
```

### โ๏ธ ุงููุดุงูู ุงููุญุชููุฉ:

#### 1. **ุงูุฅุฑุจุงู (Confusion)**
- ุงููุณุคูู ูุฑู `auto_send_eval` ูู `email_settings.php`
- ูุธู ุฃูู ูุชุญูู ูู ุฅุฑุณุงู ุงูุชููููุงุช
- ููุนููู ุฃู ูุนุทูู โ **ูุง ูุญุฏุซ ุดูุก!**

#### 2. **ุนุฏู ูุฌูุฏ Master Toggle**
ุงููุธุงู ุงูุฌุฏูุฏ **ููุณ ูู ููุชุงุญ ุฅููุงู ุดุงูู**:
- ุฅุฐุง ุฃุฑุงุฏ ุงููุณุคูู ุฅููุงู **ุฌููุน** ุฑุณุงุฆู ุงูุชููููุงุช ุจุณุฑุนุฉ
- ูุฌุจ ุชุนุทูู ูู ุงูุฅุนุฏุงุฏุงุช ุงูุซูุงุซุฉ ูุฏููุงู
- ุฃู ุชุนุทูู SMTP ููุณู (ุบูุฑ ุนููู - ูุคุซุฑ ุนูู ุฑุณุงุฆู ุฃุฎุฑู)

#### 3. **ุงูุชุดุชุช ูู ุงูุฅุนุฏุงุฏุงุช**
- `auto_send_eval` ูู ุตูุญุฉ `email_settings.php`
- ุงูุฅุนุฏุงุฏุงุช ุงูุฌุฏูุฏุฉ ูู ุตูุญุฉ `settings.php`
- ุงููุณุชุฎุฏู ูุฌุฏ ุฅุนุฏุงุฏุงุช ุงูุจุฑูุฏ ููุณูุฉ ุนูู ุตูุญุชูู

---

## 6๏ธโฃ ุงูุชูุตูุงุช

### ๐ ุงูุฎูุงุฑ ุงูููุตู ุจู: ุงุณุชุฎุฏุงู ุงูุฅุนุฏุงุฏ ุงููุฏูู ูู Master Toggle

#### โจ ุงูููุงุฆุฏ:
1. โ **ุจุณุงุทุฉ ูููุณุคูู:** ููุชุงุญ ูุงุญุฏ ูุฅููุงู/ุชุดุบูู ูู ุดูุก
2. โ **ูุชูุงูู ูุน ุงููุงุถู:** ุงูุฅุนุฏุงุฏ ููุฌูุฏ ุฃุตูุงู
3. โ **ุญูุงูุฉ ูู ุงูุฃุฎุทุงุก:** ุฅููุงู ุณุฑูุน ูู ุญุงูุฉ ุงูุทูุงุฑุฆ
4. โ **ููุทูู:** Master โ ุซู ุชูุงุตูู (ุชุฏุฑุฌ ููุทูู)

#### ๐ ุงูุชุทุจูู:
```php
// ูู EmailService->handleEvaluationSubmitted()
public function handleEvaluationSubmitted($employeeId, $cycleId, $evaluatorRole, $evaluatorId)
{
    // ๐ ุฅุถุงูุฉ ูุญุต Master Toggle ูู ุงูุจุฏุงูุฉ
    $masterEnabled = $this->getSetting('auto_send_eval', '0');
    if ($masterEnabled !== '1') {
        return; // ุฅููุงู ููุฑู ูุฌููุน ุงูุฑุณุงุฆู
    }
    
    // ... ุจุงูู ุงูููุทู ุงูุญุงูู
}
```

#### ๐จ ุชุญุณูู ุงููุงุฌูุฉ:
**ูู `email_settings.php`:**
- ุฅุนุงุฏุฉ ุชุณููุฉ: "ุฅุฑุณุงู ุชููุงุฆู ููููุธู ุนูุฏ ุงูุชูุงู ุงูุชูููู ูู ุงููุฏูุฑ"
- ุฅูู: "**ุงูููุชุงุญ ุงูุฑุฆูุณู:** ุชูุนูู ุฑุณุงุฆู ุงูุชููููุงุช (ูุชู ุงูุชุญูู ูู ุงูุชูุงุตูู ูู ุฅุนุฏุงุฏุงุช ุงููุธุงู)"
- ุฅุถุงูุฉ ุฑุงุจุท ููุฅุนุฏุงุฏุงุช ุงููุชูุฏูุฉ

---

### ๐ ุฎูุงุฑุงุช ุฃุฎุฑู:

#### ุงูุฎูุงุฑ B: ุฅุฒุงูุฉ ุงูุฅุนุฏุงุฏ ุงููุฏูู ูููุงู
**ุงููุฒุงูุง:**
- ูุธูู ููุงุถุญ
- ูุง ุชุดุชุช

**ุงูุนููุจ:**
- โ ูุง ููุฌุฏ ููุชุงุญ ุทูุงุฑุฆ ุณุฑูุน
- โ ูุฌุจ ุชุนุฏูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุงููุงุฌูุฉ
- โ ููุฏุงู ุงูุจุณุงุทุฉ

#### ุงูุฎูุงุฑ C: ุฅุนุงุฏุฉ ุชุณููุฉ ูุชูุถูุญ
- ุชุบููุฑ ุงุณู `auto_send_eval` โ `evaluation_emails_master_enabled`
- ุฌุนูู Master Toggle ุญูููู
- ุงูุงุญุชูุงุธ ุจุงูุฅุนุฏุงุฏุงุช ุงูุชูุตูููุฉ

---

## 7๏ธโฃ ุฎุทุฉ ุงูุชูููุฐ ุงูููุชุฑุญุฉ

### ุงููุฑุญูุฉ 1: ุฅุถุงูุฉ Master Toggle โ
```php
// app/core/EmailService.php
public function handleEvaluationSubmitted(...)
{
    // ูุญุต ุงูููุชุงุญ ุงูุฑุฆูุณู
    if ($this->getSetting('auto_send_eval', '0') !== '1') {
        return;
    }
    
    // ... ุงูููุทู ุงูุญุงูู
}
```

### ุงููุฑุญูุฉ 2: ุชุญุฏูุซ ุงููุงุฌูุฉ ๐จ
**`email_settings.php`:**
```php
<div class="alert alert-info mb-3">
    <i class="fas fa-info-circle"></i>
    <strong>ููุงุญุธุฉ:</strong> ูุฐุง ุงูููุชุงุญ ูุชุญูู ูู ุชูุนูู/ุชุนุทูู ุฌููุน ุฑุณุงุฆู ุงูุชููููุงุช.
    ููุชุญูู ูู <strong>ุชูุงุตูู</strong> ุงูุฅุฑุณุงู (ูุชู ูููู)ุ ุงุฐูุจ ุฅูู 
    <a href="settings.php">ุฅุนุฏุงุฏุงุช ุงููุธุงู โ ุฅุนุฏุงุฏุงุช ุงูุจุฑูุฏ ููุชููููุงุช</a>
</div>
```

### ุงููุฑุญูุฉ 3: ุงูุชูุซูู ๐
- ุชุญุฏูุซ ุฏููู ุงููุณุชุฎุฏู
- ุฅุถุงูุฉ ุชูููุญุงุช (tooltips) ูู ุงููุงุฌูุฉ
- ุชูุถูุญ ุงูุนูุงูุฉ ุจูู Master ูุงูุฅุนุฏุงุฏุงุช ุงูุชูุตูููุฉ

---

## 8๏ธโฃ ุฌุฏูู ุงูููุงุฑูุฉ ุงูููุงุฆู

| ุงูุฌุงูุจ | ุงููุธุงู ุงููุฏูู | ุงููุธุงู ุงูุฌุฏูุฏ |
|--------|--------------|---------------|
| **ุงูุฌุฏูู** | `system_settings` | `system_settings` |
| **ุงูููุงุชูุญ** | `auto_send_eval` (1) | 3 ููุงุชูุญ ูุชุฎุตุตุฉ |
| **ุงูุงุณุชุฎุฏุงู ุงูุญุงูู** | โ ุบูุฑ ูุณุชุฎุฏู | โ ููุนูู |
| **ุงูููุทู** | ุจุณูุท: ON/OFF | ูุชูุฏู: ุดุฑูุท ูุชุนุฏุฏุฉ |
| **ุงููุงุฌูุฉ** | `email_settings.php` | `settings.php` |
| **Master Toggle** | โ ููุฌูุฏ ููู ูุนุทู | โ ุบูุฑ ููุฌูุฏ |
| **ุงูุชุนุงุฑุถ** | โ ูุง ููุฌุฏ (ูุฃูู ุบูุฑ ูุณุชุฎุฏู) | - |

---

## 9๏ธโฃ ุงูุฎูุงุตุฉ ุงูููุงุฆูุฉ

### ๐ฏ ุงููุถุน:
- **ูุง ููุฌุฏ ุชุถุงุฑุจ ุชููู** ูุฃู ุงููุฏูู ุบูุฑ ูุณุชุฎุฏู
- **ููุฌุฏ ุชุดุชุช ูุนุฏู ุงุชุณุงู** ูู ุงููุงุฌูุฉ ูุงูููุทู
- **ุงููุธุงู ุงูุฌุฏูุฏ ููู ููู ููุชูุฏ ูููุชุงุญ ุงูุทูุงุฑุฆ**

### ๐ก ุงูุญู ุงูุฃูุซู:
**ุชุญููู `auto_send_eval` ุฅูู Master Toggle ูุชุญูู ูู ุงููุธุงู ุงูุฌุฏูุฏ**
- ุจุณุงุทุฉ + ููุฉ
- ุชูุงูู ูุน ุงููุงุถู + ูุณุชูุจู ุขูู
- ุชุฌุฑุจุฉ ูุณุชุฎุฏู ูุงุถุญุฉ

### ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ:
1. ุชุนุฏูู `EmailService.php` ูุฅุถุงูุฉ ุงููุญุต
2. ุชุญุฏูุซ ูุต ุงูุชูุถูุญ ูู `email_settings.php`
3. ุงุฎุชุจุงุฑ ุงูุณููุงุฑูููุงุช:
   - โ Master ON + ุฅุนุฏุงุฏ ูุฑุนู ON = ุฅุฑุณุงู
   - โ Master OFF + ุฅุนุฏุงุฏ ูุฑุนู ON = **ูุง** ุฅุฑุณุงู
   - โ Master ON + ุฅุนุฏุงุฏ ูุฑุนู OFF = ูุง ุฅุฑุณุงู

---

## ๐ ูุฑุงุฌุน ุงููููุงุช

- ูุงุนุฏุฉ ุงูุจูุงูุงุช: `al_b.sql` (ุฃุณุทุฑ 366-395)
- ุงููุธุงู ุงููุฏูู: `public/admin/email_settings.php`
- ุงููุธุงู ุงูุฌุฏูุฏ: `app/core/EmailService.php`
- ุฅุนุฏุงุฏุงุช ุงููุธุงู: `public/admin/settings.php`
- ุงุณุชุฎุฏุงู ูู ุงููุฏูุฑ: `public/manager/evaluate.php`
- ุงุณุชุฎุฏุงู ูู ุงููุดุฑู: `public/supervisor/evaluate.php`

---

**ุชุงุฑูุฎ ุงูุชุญููู:** 2024-12-13  
**ุงูุญุงูุฉ:** ุฌุงูุฒ ููุชุทุจูู โ
